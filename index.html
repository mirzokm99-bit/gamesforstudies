<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Late Study Session</title>
    <!-- Load Font Awesome for simple icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

        :root {
            --color-darkest: #0A0A0A;
            --color-eerie: #1A0A1A;
            --color-text: #D4D4D4;
            --color-accent: #880000;
            --color-accent-light: #FF5555;
            --glitch-shadow: 0 0 5px var(--color-accent);
        }

        body {
            background-color: var(--color-eerie);
            color: var(--color-text);
            font-family: 'Roboto Mono', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            overflow: auto;
            box-sizing: border-box;
            line-height: 1.6;
        }

        #game-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--color-darkest);
            border: 2px solid var(--color-accent);
            border-radius: 12px;
            box-shadow: 0 0 20px var(--color-accent), inset 0 0 10px var(--color-accent);
            padding: 25px;
            text-align: center;
            animation: pulse-border 5s infinite alternate;
        }

        @keyframes pulse-border {
            0% { border-color: var(--color-accent); box-shadow: 0 0 20px var(--color-accent), inset 0 0 10px var(--color-accent); }
            100% { border-color: #550000; box-shadow: 0 0 10px #550000, inset 0 0 5px #550000; }
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--color-accent-light);
            text-shadow: var(--glitch-shadow);
        }
        
        #inventory {
            font-size: 0.9em;
            color: #39FF14; /* Green for key status */
            margin-bottom: 10px;
            min-height: 18px;
            text-shadow: 0 0 3px #39FF14;
        }

        #dread-level {
            font-size: 0.9em;
            color: #FF5555; /* Red for dread */
            margin-bottom: 15px;
            min-height: 18px;
            text-shadow: 0 0 3px #880000;
            font-weight: bold;
        }

        #description-box {
            background-color: #1a1a1a;
            border: 1px dashed var(--color-text);
            padding: 15px;
            min-height: 150px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: left;
            white-space: pre-wrap;
            box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.1);
            transition: opacity 0.3s;
        }

        #actions-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .game-button {
            background-color: var(--color-accent);
            color: var(--color-text);
            border: 2px solid var(--color-accent-light);
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-family: 'Roboto Mono', monospace;
            text-transform: uppercase;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            animation: button-glow 3s infinite alternate;
        }

        .game-button:hover:not(:disabled) {
            background-color: var(--color-accent-light);
            color: var(--color-darkest);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 15px rgba(255, 85, 85, 0.4);
        }

        .game-button:disabled {
            background-color: #333;
            border-color: #555;
            color: #777;
            cursor: not-allowed;
            box-shadow: none;
            animation: none;
        }

        @keyframes button-glow {
            0% { box-shadow: 0 0 5px var(--color-accent); }
            100% { box-shadow: 0 0 15px var(--color-accent-light); }
        }

        .icon {
            margin-right: 8px;
        }

        #message-box {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #f0f0f0;
            min-height: 20px;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        }

        /* Mobile responsiveness */
        @media (max-width: 650px) {
            #game-container {
                margin: 10px;
                padding: 15px;
            }
            h1 {
                font-size: 1.2rem;
            }
            .game-button {
                font-size: 0.9rem;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>The Late Study Session // Room B-12</h1>
        <div id="inventory"></div>
        <div id="dread-level"></div>
        <div id="description-box"></div>
        <div id="message-box"></div>
        <div id="actions-container">
            <!-- Buttons will be generated here by JavaScript -->
        </div>
    </div>

    <!-- Audio tags kept as placeholders -->
    <audio id="ambient-sound" loop></audio>
    <audio id="scare-sound"></audio>

    <script>
        // Use a simple state object to manage the game's progress
        const gameState = {
            location: 'rules_screen', // Start at the rules screen
            investigated_desk: false,
            investigated_books: false,
            investigated_window: false,
            investigated_door: false,
            has_keycard: false,
            final_reveal: false, // True if an ending has been triggered
            dread_level: 0, // Tracks player's exposure to strange events (Max 6, Threshold 4 for Madness)
        };

        // Game data: descriptions and available actions for each state
        const gameData = {
            'rules_screen': {
                description: 
                    "RULES OF THE GAME\n" +
                    "Your goal is simple: Escape the building and survive the night (Ending 1/3).\n\n" +
                    "1. Interaction: Click the action buttons to move, investigate, and interact with the environment.\n\n" +
                    "2. Dread Level: Investigating strange clues and encountering chilling events will increase your DREAD LEVEL. If Dread reaches 4 or higher, you risk descending into madness (Ending 3/3).\n\n" +
                    "3. Room B-12: The study hall has clues, but lingering too long and checking every clue before leaving will trigger a passive, terrible ending (Ending 2/3). Speed is crucial.\n\n" +
                    "4. Escape: You need to find a way to unlock the main entrance to achieve the Survivor Ending. Look for the Janitor's Keycard.",
                actions: [
                    { text: "Start the Study Session...", nextState: 'start', requiredState: null, icon: 'fa-arrow-right' }
                ]
            },
            'start': {
                description: "It's 2:17 AM. You're the last person in the campus study hall (Room B-12). The air is stale, and the low hum of the fluorescent lights is now punctuated by a faint, wet scraping sound from the hallway. You need to gather your things and leave. The door rattles slightly.",
                actions: [
                    { text: "Check your desk (Clue)", nextState: 'desk_investigate', requiredState: 'investigated_desk', icon: 'fa-book' },
                    { text: "Look at the stacks of books (Clue)", nextState: 'books_investigate', requiredState: 'investigated_books', icon: 'fa-layer-group' },
                    { text: "Glance out the window (Clue)", nextState: 'window_investigate', requiredState: 'investigated_window', icon: 'fa-window-maximize' },
                    { text: "Try the exit door (in B-12)", nextState: 'door_attempt', requiredState: 'investigated_door', icon: 'fa-lock' },
                    { text: "Open the study hall door to the hallway", nextState: 'hallway', requiredState: null, icon: 'fa-arrow-right-to-bracket' }
                ]
            },
            'desk_investigate': {
                description: "You check your desk. The notes are scattered. You find a tiny, black feather stuck to your textbook—odd, as there are no birds inside. Your hands feel cold, and you could swear your chair just rocked slightly.",
                updateState: 'investigated_desk',
                dreadIncrease: 1,
                actions: [{ text: "Go back to the room", nextState: 'start', requiredState: null, icon: 'fa-reply' }]
            },
            'books_investigate': {
                description: "The shelves loom over you. As you reach for a book, you feel a faint, cool breath on the back of your neck. You whirl around—nothing. A single book on a high shelf is open to a page with a crudely drawn, repeating eye pattern.",
                updateState: 'investigated_books',
                dreadIncrease: 1,
                actions: [{ text: "Go back to the room", nextState: 'start', requiredState: null, icon: 'fa-reply' }]
            },
            'window_investigate': {
                description: "You peer out the rain-streaked window. The streetlights are foggy. You see a shape, fleeting, moving unnaturally fast between the trees. It stops. You realize... it's looking *up* at you, and you think you see a flicker of red in its reflection.",
                updateState: 'investigated_window',
                dreadIncrease: 1,
                actions: [{ text: "Go back to the room", nextState: 'start', requiredState: null, icon: 'fa-reply' }]
            },
            'door_attempt': {
                description: "The study hall's main door is locked. As you pull the handle, the safety chain rattles *from the inside*. You know the chain wasn't on before. A slow, metallic scrape echoes down the hall, much closer now. You need to escape the building entirely.",
                updateState: 'investigated_door',
                dreadIncrease: 1,
                actions: [{ text: "Go back to the room", nextState: 'start', requiredState: null, icon: 'fa-reply' }]
            },
            
            // NEW LOCATIONS
            'hallway': {
                description: "You step out into the long, dark hallway. Only the emergency lights are on, casting long, unsettling shadows. The wet scraping sound is definitely from this floor. There's a set of stairs down to the main entrance, a door marked 'Restroom', and a small, unmarked door that looks like a Janitor's Closet.",
                actions: [
                    { text: "Go back into the study hall (B-12)", nextState: 'start', requiredState: null, icon: 'fa-reply' },
                    { text: "Investigate the restroom", nextState: 'bathroom_investigate', requiredState: null, icon: 'fa-restroom' },
                    { text: "Pry open the Janitor's Closet door", nextState: 'janitor_closet', requiredState: null, icon: 'fa-broom' },
                    { text: "Proceed to the main entrance (Downstairs)", nextState: 'main_entrance_attempt', requiredState: null, icon: 'fa-stairs' }
                ]
            },
            'bathroom_investigate': {
                description: "The restroom is cleaner than you expected, but the air is heavy with the smell of ozone. The lights flicker rapidly. You look in the mirror and a fleeting image flashes—not your own face, but a blurred, desperate face staring back from the darkness behind you. When you turn, the hall is empty. Your heart is pounding.",
                dreadIncrease: 1,
                actions: [{ text: "Go back to the Hallway", nextState: 'hallway', requiredState: null, icon: 'fa-reply' }]
            },

            // New Location with item logic
            'janitor_closet': {
                // Dynamic content for description and state update
                description: (state) => {
                    if (state.has_keycard) {
                        return "The closet is cramped and smells faintly of bleach and something metallic. You already took the keycard. The only thing left here is an old, rusted mop bucket that seems to shift slightly in the gloom.";
                    } else {
                        return "The closet is cramped. Among the stacked boxes of paper towels and industrial cleaner, a cheap, plastic Janitor's Keycard is hanging on a hook next to a dirty yellow vest. You quickly pocket it. The scraping sound outside stops.";
                    }
                },
                updateState: (state) => {
                    if (!state.has_keycard) {
                        return 'has_keycard'; // Sets the flag if not already set
                    }
                    return null;
                },
                dreadIncrease: 1,
                actions: [{ text: "Return to the Hallway", nextState: 'hallway', requiredState: null, icon: 'fa-reply' }]
            },

            // ENDING PATHS
            'main_entrance_attempt': {
                // Description and actions are handled dynamically in updateGame
                description: (state) => {
                    if (state.has_keycard) {
                        return "You reach the main entrance doors. They are solid oak and secured by a multi-bolt electronic lock. You swipe the Janitor's Keycard. The lights on the panel flicker GREEN. You can now leave.";
                    } else {
                        return "You reach the main entrance doors. They are solid oak and secured by a multi-bolt electronic lock. You realize you need a keycard or code to activate the release. The door clicks and the safety chain rattles on the *inside* of these doors too. You cannot proceed.";
                    }
                },
                actions: (state) => {
                    let actions = [];
                    actions.push({ text: "Go back to the hallway", nextState: 'hallway', requiredState: null, icon: 'fa-reply' });
                    if (state.has_keycard) {
                        actions.push({ text: "EXIT BUILDING (FINALE)", nextState: 'escape_success', requiredState: null, icon: 'fa-walkie-talkie' });
                    }
                    return actions;
                }
            },
            'escape_success': {
                description: "You slam the heavy oak door open and run out onto the quad. The cool night air hits your face. You don't look back. You escape the campus. It was just a strange, late night. The feeling of dread slowly fades.\n\n[Ending 1/3: The Survivor]",
                actions: [{ text: "Start New Session (Go back to studying)", nextState: 'rules_screen', requiredState: null, icon: 'fa-arrow-rotate-left' }]
            },

            // BAD ENDING 1 (Triggered by checking all four items and returning to start)
            'end_reveal': {
                description: "You've checked everything in the study hall. You stand in the center, and the low hum of the lights stops. Silence. Absolute, oppressive silence. You realize you have exhausted all investigation points but have not solved the problem of the door. The low, grating whisper that seems to come from the floor itself says: 'Y O U  N E V E R  L E F T.'\n\nYou look down at your hands. The notes you've been reviewing? They are transcripts of emergency services calls from 1998 about an incident in this very study hall, and the feather, the eye, the fast-moving shape—they were never external. You were here the whole time, and the light just flickered out.\n\n[Ending 2/3: The Transcribed]",
                actions: [
                    { text: "Start New Session (Reset Game)", nextState: 'rules_screen', requiredState: null, icon: 'fa-arrow-rotate-left' }
                ]
            },

            // BAD ENDING 2 (Triggered by high dread level)
            'madness_ending': {
                description: "The shadows are moving. The fluorescent lights are screaming. The scraping sound becomes deafening. You try to focus on the door, but your body won't obey. A million whispers, all speaking your name, overwhelm your thoughts. You fall to your knees, and the last thing you see is the room reforming around you, becoming a cage of endless study and silence. Reality breaks. You didn't escape the building. You never left your own mind.\n\n[Ending 3/3: The Madness]",
                actions: [
                    { text: "Start New Session (Reset Game)", nextState: 'rules_screen', requiredState: null, icon: 'fa-arrow-rotate-left' }
                ]
            }
        };

        const descriptionBox = document.getElementById('description-box');
        const actionsContainer = document.getElementById('actions-container');
        const inventoryDisplay = document.getElementById('inventory');
        const dreadDisplay = document.getElementById('dread-level');
        const messageBox = document.getElementById('message-box');
        
        /**
         * Checks if the player has investigated all four initial points in the starting room.
         */
        function checkGameEnd() {
            return gameState.investigated_desk &&
                   gameState.investigated_books &&
                   gameState.investigated_window &&
                   gameState.investigated_door;
        }

        /**
         * Handles the transition to a new game state.
         * @param {string} newStateKey The key of the new state in gameData.
         */
        function updateGame(newStateKey) {
            let stateKey = newStateKey;

            // If user clicks START NEW SESSION button from an ending screen, we route to resetGame
            if (stateKey === 'rules_screen' && gameState.final_reveal) {
                resetGame();
                return;
            }

            const currentState = gameData[stateKey];
            gameState.location = stateKey; // Update location immediately

            // 1. DREAD LEVEL INCREASE & STATE UPDATE (Only if not already ending and not the rules screen)
            if (!gameState.final_reveal && stateKey !== 'rules_screen') {
                
                // Handle Dread Increase
                if (currentState.dreadIncrease) {
                    gameState.dread_level += currentState.dreadIncrease;
                }

                // Handle State Update (Clues, Keycard)
                if (typeof currentState.updateState === 'function') {
                    const flagToSet = currentState.updateState(gameState);
                    if (flagToSet) {
                        gameState[flagToSet] = true;
                    }
                } else if (currentState.updateState) {
                    gameState[currentState.updateState] = true;
                }
            }


            // 2. CHECK FOR ENDINGS (MUST be done after state/dread update)
            
            // Check for Bad End 2 (Madness - Dread too high)
            if (gameState.dread_level >= 4 && !gameState.final_reveal && stateKey !== 'escape_success' && stateKey !== 'end_reveal' && stateKey !== 'rules_screen') {
                stateKey = 'madness_ending';
                gameState.final_reveal = true;
            }
            
            // Check for Bad End 1 (Transcribed - All B-12 clues found, player returns to start)
            if (stateKey === 'start' && checkGameEnd() && !gameState.final_reveal) {
                stateKey = 'end_reveal';
                gameState.final_reveal = true;
            }

            const finalState = gameData[stateKey]; // Re-reference the state after all potential ending checks
            
            // 3. Update the UI components
            
            // Handle dynamic descriptions
            if (typeof finalState.description === 'function') {
                descriptionBox.textContent = finalState.description(gameState);
            } else {
                descriptionBox.textContent = finalState.description;
            }

            actionsContainer.innerHTML = ''; // Clear old buttons
            messageBox.textContent = ''; // Clear message

            // Inventory and Dread only show when NOT on the rules or ending screen
            if (stateKey === 'rules_screen' || gameState.final_reveal) {
                inventoryDisplay.innerHTML = '';
                dreadDisplay.innerHTML = '';
            } else {
                // Update Inventory Display 
                inventoryDisplay.innerHTML = gameState.has_keycard 
                    ? '<i class="fas fa-key"></i> INVENTORY: Janitor\'s Keycard' 
                    : '<i class="fas fa-lock"></i> INVENTORY: None';
                
                // Update Dread Level Display
                dreadDisplay.innerHTML = `<i class="fas fa-skull"></i> DREAD LEVEL: ${gameState.dread_level} / 4 (DANGER)`;
            }

            // 4. Generate new buttons
            const actions = typeof finalState.actions === 'function' 
                            ? finalState.actions(gameState) 
                            : finalState.actions;

            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = 'game-button';
                button.innerHTML = `<i class="icon fas ${action.icon}"></i> ${action.text}`;
                
                // Disable button if the specific action in the START room has already been taken
                const isInvestigated = action.requiredState && gameState[action.requiredState];
                
                if (isInvestigated && finalState === gameData['start']) {
                    button.disabled = true;
                    button.innerHTML = `<i class="icon fas fa-check"></i> ${action.text} (DONE)`;
                }

                button.onclick = () => {
                    updateGame(action.nextState);
                };

                actionsContainer.appendChild(button);
            });

            // 5. Simple transition effect
            descriptionBox.style.opacity = 0;
            setTimeout(() => {
                descriptionBox.style.opacity = 1;
            }, 50);
        }

        /**
         * Resets the game to the initial state.
         */
        function resetGame() {
            gameState.location = 'rules_screen';
            gameState.investigated_desk = false;
            gameState.investigated_books = false;
            gameState.investigated_window = false;
            gameState.investigated_door = false;
            gameState.has_keycard = false;
            gameState.final_reveal = false;
            gameState.dread_level = 0;
            updateGame('rules_screen'); // Start at rules screen
        }

        // Initialize the game on load
        window.onload = () => {
             resetGame(); // Ensure a clean start at the rules screen
        };

    </script>
</body>
</html>
