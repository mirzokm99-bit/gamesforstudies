<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVP Command: The Unit Challenge (Solo Mode)</title>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <style>
        /* --- General Styling (Cyber-Finance Theme) --- */
        body { 
            font-family: 'Consolas', 'Courier New', monospace; 
            margin: 0; 
            background-color: #1A1A2E; /* Deep dark background */
            color: #E0FFFF; /* Neon Cyan for text */
            line-height: 1.6; 
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 30px 15px;
        }
        .container { 
            max-width: 900px; 
            width: 100%;
            margin: 0;
            background-color: #0F0F1A; /* Slightly lighter inner background */
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.4); /* Cyan glow */
            border: 3px solid #00FFFF;
            transition: all 0.3s ease-in-out;
        }
        
        h1, h2, h3 { 
            color: #39FF14; /* Neon Green */
            text-align: center; 
            margin-bottom: 25px; 
            text-shadow: 0 0 5px #39FF14;
        }
        h1 { 
            font-size: 3em; 
            letter-spacing: 3px; 
            border-bottom: 2px solid #00FFFF;
            padding-bottom: 10px;
            margin-top: 0;
        }

        /* --- Input and Control Layout --- */
        .input-group { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            margin-bottom: 35px; 
            justify-content: center; 
        }
        .input-item { 
            flex: 1 1 200px; 
            padding: 15px; 
            border-radius: 8px; 
            background-color: #1a1a2e;
            border: 1px solid #00FFFF;
            box-shadow: inset 0 0 8px rgba(0, 255, 255, 0.5);
        }
        .input-item label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: bold; 
            color: #39FF14; 
            font-size: 1em; 
        }
        .input-item input[type="number"] { 
            width: 100%; 
            padding: 10px; 
            border: none; 
            border-radius: 4px; 
            font-size: 1.2em; 
            box-sizing: border-box; 
            background-color: #0F0F1A;
            color: #E0FFFF;
            box-shadow: 0 0 5px #00FFFF;
            text-align: center;
        }
        
        /* --- Challenge Panel (Warning/Alert Style) --- */
        #challengePanel {
            background: #4a1515; /* Dark red for urgency */
            border: 3px solid #FF0077; /* Neon Magenta border */
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 0 15px rgba(255, 0, 119, 0.7);
        }
        #challengeText { 
            font-size: 1.6em; 
            color: #FF0077; 
            font-weight: bold; 
            margin-bottom: 20px; 
            text-shadow: 0 0 5px #FF0077;
        }
        #answerInputContainer { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 15px; 
        }
        #answerInput { 
            padding: 12px; 
            font-size: 1.3em; 
            width: 180px; 
            border: 2px solid #FF0077; 
            border-radius: 5px; 
            background-color: #0F0F1A;
            color: #E0FFFF;
        }
        
        /* --- Buttons (Neon/Gradient) --- */
        .button-group { display: flex; justify-content: space-around; max-width: 800px; margin: 20px auto; }
        .button-group button { 
            width: 100%; margin: 0 10px; padding: 15px 15px; font-size: 1.2em; 
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
            transition: all 0.3s ease; 
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
        }
        .button-group button:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 15px rgba(0, 255, 255, 0.6); 
        }

        #submitButton { 
            background: linear-gradient(45deg, #39FF14, #00CC00); 
            color: #1A1A2E; 
        }
        #submitButton:hover { box-shadow: 0 8px 15px rgba(57, 255, 20, 0.8); }

        #nextButton { 
            background: linear-gradient(45deg, #00FFFF, #0077FF); 
            color: #1A1A2E; 
            display: none; 
        }
        #nextButton:hover { box-shadow: 0 8px 15px rgba(0, 255, 255, 0.8); }

        #restartButton { 
            background: linear-gradient(45deg, #FFC107, #FF9900); 
            color: #1A1A2E; 
        }
        #restartButton:hover { box-shadow: 0 8px 15px rgba(255, 193, 7, 0.8); }

        #finishButton { 
            background: linear-gradient(45deg, #DC3545, #990000); 
            color: #E0FFFF; 
            border: 1px solid #FF0077;
        }
        #finishButton:hover { box-shadow: 0 8px 15px rgba(220, 53, 69, 0.8); }

        /* --- Status and Score --- */
        #scoreDisplay { 
            text-align: center; 
            font-size: 2.5em; 
            color: #FF0077; /* Neon Magenta */
            font-weight: bold; 
            margin-bottom: 25px; 
            text-shadow: 0 0 10px #FF0077;
        }
        #feedbackMessage { 
            margin-top: 20px; 
            padding: 12px; 
            border-radius: 6px; 
            font-weight: bold; 
            display: none; 
            text-shadow: none;
        }
        .feedback-correct { 
            background-color: #0A3D2A; /* Dark green background */
            color: #39FF14; /* Bright green text */
            border: 1px solid #39FF14; 
        }
        .feedback-incorrect { 
            background-color: #3A1515; /* Dark red background */
            color: #FF0077; /* Bright magenta text */
            border: 1px solid #FF0077; 
        }

        /* --- Help Button and Info Box --- */
        .help-button { 
            background: #00FFFF; 
            color: #1A1A2E; 
            border: none; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            text-align: center; 
            line-height: 20px; 
            font-size: 0.8em; 
            font-weight: 900; 
            cursor: pointer; 
            margin-left: 8px; 
            display: inline-block; 
            vertical-align: middle; 
            box-shadow: 0 0 5px #00FFFF;
        }
        .info-box { 
            background-color: #1a1a2e; 
            border-left: 5px solid #00FFFF; 
            padding: 15px; 
            margin-top: 25px; 
            margin-bottom: 25px;
            border-radius: 5px; 
            color: #E0FFFF; 
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
            text-align: center;
        }
        .info-box strong { color: #39FF14; }

        /* --- Setup & Modal Styling --- */
        #playerSetup { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.95); z-index: 1000; display: flex; 
            justify-content: center; align-items: center; 
        }
        #playerSetup div { 
            background-color: #0F0F1A; 
            padding: 50px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 0 30px rgba(0,255,255,0.7); 
            border: 2px solid #00FFFF;
        }
        #playerNameInput {
            padding: 10px; font-size: 1.2em; border: 2px solid #39FF14; border-radius: 5px; 
            background-color: #1A1A2E; color: #E0FFFF; text-align: center;
            width: 80%; max-width: 300px;
        }
        #playerSetup button {
            background-color: #39FF14; color: #1A1A2E; padding: 12px 25px; font-weight: bold;
            border-radius: 8px; margin-top: 20px; cursor: pointer; transition: transform 0.2s;
        }

        #customModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.85); z-index: 2000; justify-content: center; 
            align-items: center; opacity: 0; transition: opacity 0.2s;
        }
        #customModal > div {
            background-color: #0F0F1A; padding: 30px; border-radius: 10px; max-width: 400px; 
            text-align: center; box-shadow: 0 0 20px rgba(255, 0, 119, 0.7);
            border: 2px solid #FF0077;
            color: #E0FFFF;
        }
        #modalTitle { color: #39FF14 !important; text-shadow: 0 0 5px #39FF14; }
        #modalButtons button {
            padding: 10px 20px; border-radius: 6px; font-weight: bold; margin: 0 5px;
            cursor: pointer; transition: background-color 0.2s; color: #1A1A2E;
        }
        #modalButtons button:nth-child(1) { background-color: #FF0077; color: #E0FFFF;}
        #modalButtons button:nth-child(2) { background-color: #00FFFF; }


        /* --- Responsive Adjustments --- */
        @media (max-width: 600px) {
            body { padding: 15px; }
            .container { padding: 20px; }
            h1 { font-size: 2em; letter-spacing: 2px; }
            .input-group { flex-direction: column; }
            .button-group { flex-direction: column; gap: 10px; }
            .button-group button { margin: 5px 0; }
            #challengeText { font-size: 1.3em; }
            #scoreDisplay { font-size: 1.8em; }
        }
    </style>
</head>
<body>
        <!-- Custom Modal/Dialog for Alerts and Confirmations -->
    <div id="customModal">
        <div>
            <h3 id="modalTitle">Notification</h3>
            <p id="modalMessage" style="margin-bottom: 20px; white-space: pre-wrap;"></p>
            <div id="modalButtons">
            </div>
        </div>
    </div>

        <!-- Player Name Setup Screen (Modal) -->
    <div id="playerSetup">
        <div>
            <h2>CVP COMMAND:  SOLO CHALLENGE SETUP</h2>
            <p>1. Enter your Name/Role (Your progress will be encrypted):</p>
            <input type="text" id="playerNameInput" placeholder="Agent Name/Role" />
            <button onclick="startGame()">
                EXECUTE CHALLENGE
            </button>
            <p style="margin-top: 15px; font-size: 0.9em; color: #00FFFF;">
                <span style="font-size: 1.5em;">&#9658;</span> Prepare for Profitability Analysis.
            </p>
        </div>
    </div>

    <div class="container" style="display: none;" id="gameContainer">
        <h1>CVP Command: The Unit Challenge</h1>

        <!-- Score and Player Info -->
        <div id="scoreDisplay">SYNCHRONIZING DATA...</div>

        <div id="onlinePlayers" class="info-box">
            <strong>AGENT ID:</strong> <span id="currentPlayerName" style="color:#FF0077;"></span>
            <hr style="border-top: 1px dashed #00FFFF44;">
            <strong>CURRENT MISSION LEVEL:</strong> <span id="levelTitle" style="color:#00FFFF;"></span>
        </div>

        <!-- Input Data Board -->
        <h2>DATA INPUT MODULE (P, V, F, S)</h2>
        <div class="input-group">
            <div class="input-item">
                <label>Selling Price (P):
                    <span class="help-button" onclick="showHelp('P')">?</span>
                </label>
                <input type="number" id="sellingPrice" value="50" disabled>
            </div>
            <div class="input-item">
                <label>Variable Cost (V):
                    <span class="help-button" onclick="showHelp('V')">?</span>
                </label>
                <input type="number" id="variableCost" value="20" disabled>
            </div>
            <div class="input-item">
                <label>Fixed Costs (F):
                    <span class="help-button" onclick="showHelp('F')">?</span>
                </label>
                <input type="number" id="fixedCosts" value="15000" disabled>
            </div>
            <div class="input-item">
                <label>Target Sales Units (S):
                    <span class="help-button" onclick="showHelp('S')">?</span>
                </label>
                <input type="number" id="salesUnits" value="1000" disabled>
            </div>
        </div>

        <!-- Challenge Panel -->
        <div id="challengePanel">
            <h2>CURRENT CHALLENGE: <span id="roundTitle"></span></h2>
            <p id="challengeText">System Initializing...</p>

            <div id="answerInputContainer">
                <input type="number" id="answerInput" placeholder="INPUT RESPONSE (Numeric)" step="0.01">
                <span class="help-button" onclick="showHelp('Current')">?</span>
            </div>

            <div id="feedbackMessage"></div>
        </div>
        <div class="button-group">
            <button id="submitButton" onclick="submitAnswer()">SUBMIT RESPONSE</button>
            <button id="nextButton" onclick="nextRound()">NEXT CHALLENGE</button>
        </div>

        <div class="button-group" style="margin-top: 5px;">
            <button id="restartButton" onclick="restartGame()">REINITIALIZE SYSTEM (Restart)</button>
            <button id="finishButton" onclick="finishGame()">COMPLETE MISSION & GRADE</button>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Variables (Mandatory Canvas Setup)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, currentUserId;
        let myPlayerName = '';
        let currentScore = 0;
        let currentRound = 0; // 1-indexed number of the current active round. 0 means game hasn't started.
        let currentLevelIndex = 0; // 0-indexed reference to gameLevels
        let unsubscribeSnapshot = null; // Listener reference
        const SOLO_DOC_ID = 'solo_session'; // Fixed document ID for solo play

        // --- CVP Definitions ---
        const cvpDefinitions = {
            P: { title: "Selling Price (P)", definition: "The price at which a single unit of the product is sold to the customer. This is the revenue generated per unit." },
            V: { title: "Variable Cost (V)", definition: "Costs that change in proportion to the volume of output. Examples include direct materials and direct labor. This is the cost incurred per unit." },
            F: { title: "Fixed Costs (F)", definition: "Costs that remain constant regardless of the volume of production or sales, within a relevant range. Examples include rent, salaries, and depreciation." },
            S: { title: "Target Sales Units (S)", definition: "The specific number of units the company plans or aims to sell, often used to calculate expected profit or margin of safety." },
            Current: { title: "Current Challenge Hint", definition: "Formula hint for the active CVP calculation." } // Placeholder for challenge hints
        };

        // --- Challenge Data & Levels ---
        const challenges = [
            { title: "Contribution Margin (CM) Per Unit", text: "Calculate the Contribution Margin per unit (P - V). Round to 2 decimal places.", calculate: (P, V, F, S) => (P - V).toFixed(2), unit: "$", difficulty: 50, hint: "Formula: CM = Selling Price (P) - Variable Cost (V)." },
            { title: "Break-Even Point in Units", text: "How many units must the company sell to cover all Fixed Costs (BEP)? Round up to the nearest whole unit.", calculate: (P, V, F, S) => Math.ceil(F / (P - V)), unit: " units", difficulty: 75, hint: "Formula: BEP (Units) = Fixed Costs (F) / Contribution Margin (CM)." },
            { title: "Current Total Profit (TP)", text: "What is the total profit/loss at the current Target Sales (S)? Round to 2 decimal places.", calculate: (P, V, F, S) => ((S * (P - V)) - F).toFixed(2), unit: "$", difficulty: 100, hint: "Formula: Profit = (Sales Units * CM) - Fixed Costs." },
            { title: "Margin of Safety Percentage", text: "Calculate the Margin of Safety Percentage (MoS%) at current Target Sales (S). Round to 2 decimal places.", calculate: (P, V, F, S) => { const CM = P - V; const BEP_units = F / CM; const MoS_units = S - BEP_units; return ((MoS_units / S) * 100).toFixed(2); }, unit: "%", difficulty: 125, hint: "Formula: MoS% = ((Target Sales - BEP Sales) / Target Sales) * 100." },
            { title: "Required Sales Units (Target Profit $8k)", text: "What sales units (S) are needed to hit a Target Profit of $8,000? Round up to the nearest whole unit.", calculate: (P, V, F, S) => Math.ceil((F + 8000) / (P - V)), unit: " units", difficulty: 150, hint: "Formula: Required Sales = (Fixed Costs + Target Profit) / CM." },
            { title: "Required Selling Price (Target Profit $6k)", text: "To hit a Target Profit of $6,000, what must the Selling Price (P) be? Round to 2 decimal places.", calculate: (P, V, F, S) => { const requiredCM = (F + 6000) / S; return (requiredCM + V).toFixed(2); }, unit: "$", difficulty: 175, hint: "Solve for P in the Target Profit formula." },
            { title: "CM Ratio (CM%)", text: "Calculate the Contribution Margin Ratio (CM/P). Round to 3 decimal places (e.g., 0.600).", calculate: (P, V, F, S) => ((P - V) / P).toFixed(3), unit: " Ratio", difficulty: 100, hint: "CM Ratio = Contribution Margin / Selling Price. This is useful for CVP analysis in dollars." },
            { title: "New Fixed Costs (Profit Goal)", text: "Given a new Target Sales (S) of 1,200 units, what maximum Fixed Costs (F) can the company afford while still achieving a Target Profit of $5,000? Round to the nearest whole dollar.", calculate: (P, V, F, S) => { const CM = P - V; return Math.round((1200 * CM) - 5000); }, unit: "$", difficulty: 200, hint: "Rearrange the Profit formula: F = (Sales Units * CM) - Target Profit." }
        ];

        const roundsPerLevel = challenges.length; // 8 challenges
        
        const gameLevels = [
            {
                level: 1,
                title: "Level 1: Introduction to Break-Even",
                data: { P: 50, V: 20, F: 15000, S: 1000 }
            },
            {
                level: 2,
                title: "Level 2: Pricing Strategy & Sensitivity",
                data: { P: 65, V: 35, F: 25000, S: 1500 }
            }
        ];

        const totalGameRounds = gameLevels.length * roundsPerLevel; // 16 rounds total

        // --- CUSTOM MODAL UTILITIES (Replaces alert() and confirm()) ---
        function showModal(title, message, isConfirm, callback) {
            const modal = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalButtons = document.getElementById('modalButtons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';
                        
            // Close function
            const closeModal = () => {
                modal.style.opacity = '0';
                setTimeout(() => { modal.style.display = 'none'; }, 200); // Wait for transition
            };
                        
            if (isConfirm) {
                // Confirm buttons (Yes/No)
                const yesBtn = document.createElement('button');
                yesBtn.textContent = 'Yes, Proceed';
                yesBtn.style.cssText = 'background-color: #FF0077; color: #E0FFFF; padding: 10px 20px; border: none; border-radius: 6px; margin-right: 10px; cursor: pointer;';
                yesBtn.onclick = () => { closeModal(); callback(true); };
                                
                const noBtn = document.createElement('button');
                noBtn.textContent = 'Cancel';
                noBtn.style.cssText = 'background-color: #00FFFF; color: #1A1A2E; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;';
                noBtn.onclick = () => { closeModal(); callback(false); };

                modalButtons.appendChild(yesBtn);
                modalButtons.appendChild(noBtn);

            } else {
                // Alert button (OK)
                const okBtn = document.createElement('button');
                okBtn.textContent = 'ACKNOWLEDGE';
                okBtn.style.cssText = 'background-color: #39FF14; color: #1A1A2E; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;';
                okBtn.onclick = () => { closeModal(); if(callback) callback(); };
                                
                modalButtons.appendChild(okBtn);
            }

            modal.style.display = 'flex';
            setTimeout(() => { modal.style.opacity = '1'; }, 10);
        }

        // --- FIREBASE INITIALIZATION & AUTH ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                currentUserId = auth.currentUser.uid;

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                showModal("SYSTEM ERROR", "Error connecting to secure system. Check console for details.", false);
            }
        }

        // --- GAME FLOW CONTROLS ---
        async function startGame() {
            if (!db) await initializeFirebase();

            const nameInput = document.getElementById('playerNameInput');
            myPlayerName = nameInput.value.trim();

            if (myPlayerName.length < 2) {
                showModal("ACCESS DENIED", "Agent Name/Role must be at least 2 characters.", false);
                return;
            }

            document.getElementById('currentPlayerName').textContent = myPlayerName;

            // Set up the game session and real-time listener (using fixed solo path)
            await setupGameSession();

            // Hide setup and show game
            document.getElementById('playerSetup').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
                        
            // Start the first round or resume from loaded progress
            restartGame(true); 
         }

        async function setupGameSession() {
            // Path for private, solo data: /artifacts/{appId}/users/{userId}/cvp_solo_game/solo_session
            const soloRef = doc(db, `artifacts/${appId}/users/${currentUserId}/cvp_solo_game`, SOLO_DOC_ID);

            // 1. Update the solo document with the player's initial data or load existing data
            try {
                await runTransaction(db, async (transaction) => {
                    const soloDoc = await transaction.get(soloRef);

                    if (soloDoc.exists()) {
                        // Load existing data
                        const data = soloDoc.data();
                        myPlayerName = data.playerName || myPlayerName;
                        currentScore = data.score || 0;
                        currentRound = data.round || 0;
                        currentLevelIndex = data.levelIndex || 0;
                        
                        // Update UI with loaded player name
                        document.getElementById('playerNameInput').value = myPlayerName;
                        document.getElementById('currentPlayerName').textContent = myPlayerName;
                    } else {
                        // Set initial data if document doesn't exist
                        transaction.set(soloRef, {
                            playerName: myPlayerName,
                            score: currentScore,
                            round: currentRound,
                            levelIndex: currentLevelIndex,
                            lastUpdated: new Date().toISOString()
                        });
                    }
                });

                // 2. Set up the real-time listener
                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot(); // Stop any previous listener
                }

                unsubscribeSnapshot = onSnapshot(soloRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        handleSoloUpdate(docSnapshot.data());
                    } else {
                        console.log("Solo session data not found.");
                    }
                });

            } catch (error) {
                console.error("Transaction failed during setup:", error);
                showModal("DATA INITIATION ERROR", "Failed to start solo session. Check console.", false);
            }
        }

        // Listener Handler - Updates local state with persisted data
        function handleSoloUpdate(data) {
            currentScore = data.score || 0;
            currentRound = data.round || 0;
            currentLevelIndex = data.levelIndex || 0;

            const currentLevel = gameLevels[currentLevelIndex]?.level || 1;
            document.getElementById('scoreDisplay').textContent = `SCORE: ${currentScore} PTS (Lvl ${currentLevel}, Rnd ${currentRound}/${totalGameRounds})`;
            
            // Re-initialize inputs and next round state based on loaded data
            initializeInputs(); 
        }

        // --- DATA UPDATE ---
        async function updateSoloState() {
            if (!currentUserId || !db) return;

            const soloRef = doc(db, `artifacts/${appId}/users/${currentUserId}/cvp_solo_game`, SOLO_DOC_ID);
            try {
                await runTransaction(db, async (transaction) => {
                    const soloDoc = await transaction.get(soloRef);
                                        
                    // Update score, round, and level index
                    transaction.set(soloRef, {
                        playerName: myPlayerName,
                        score: currentScore,
                        round: currentRound,
                        levelIndex: currentLevelIndex,
                        lastUpdated: new Date().toISOString()
                    }, { merge: true }); // Use merge to ensure only these fields are updated
                });
            } catch (error) {
                console.error("Error updating solo state:", error);
            }
        }

        // --- INPUT & LEVEL MANAGEMENT ---
        function initializeInputs() {
            // Guard against index out of bounds if game data is corrupted
            if (currentLevelIndex >= gameLevels.length || currentLevelIndex < 0) {
                 currentLevelIndex = 0;
            }

            const data = gameLevels[currentLevelIndex].data;
            document.getElementById('sellingPrice').value = data.P;
            document.getElementById('variableCost').value = data.V;
            document.getElementById('fixedCosts').value = data.F;
            document.getElementById('salesUnits').value = data.S;
            document.getElementById('levelTitle').textContent = gameLevels[currentLevelIndex].title.toUpperCase();
        }
        
        // Helper function to update all UI elements for the current round (index)
        function updateRoundUI() {
            // currentRound is the 1-indexed number of the active round.
            if (currentRound === 0 || currentRound > totalGameRounds) return;
            
            const currentChallengeIndex = (currentRound - 1) % roundsPerLevel;
            const challenge = challenges[currentChallengeIndex];
            
            const currentLevel = gameLevels[currentLevelIndex].level;
            const roundInLevel = currentChallengeIndex + 1;
                        
            // Reset UI for the new round
            document.getElementById('roundTitle').textContent = `RND ${roundInLevel}/${roundsPerLevel}`;
            document.getElementById('challengeText').textContent = challenge.text;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('submitButton').style.display = 'block';
            document.getElementById('nextButton').style.display = 'none';
            document.getElementById('feedbackMessage').style.display = 'none';
            document.getElementById('scoreDisplay').textContent = `SCORE: ${currentScore} PTS (Lvl ${currentLevel}, Rnd ${currentRound}/${totalGameRounds})`;

            // Push local progress to Firebase (since we are updating state/UI)
            updateSoloState(); 
        }

        function goToRound(targetRound) {
            // targetRound is the 1-indexed round the player is currently on (e.g., 5)
            currentRound = targetRound; 
            
            // Calculate level index based on the 1-indexed round number
            currentLevelIndex = Math.floor((currentRound - 1) / roundsPerLevel);
            
            // Ensure inputs are correctly set for the target level
            initializeInputs();
            
            // Update UI for the current round (which is targetRound)
            updateRoundUI();
        }


        // --- GAME LOGIC ---
        function showHelp(conceptKey) {
            const definitions = cvpDefinitions[conceptKey];

            if (conceptKey === 'Current') {
                // If round is 0, default to index 0 (Round 1 challenge) for the hint text
                const currentChallengeIndex = currentRound === 0 ? 0 : (currentRound - 1) % roundsPerLevel;
                const challenge = challenges[currentChallengeIndex];
                showModal(`CHALLENGE HINT: ${challenge.title.toUpperCase()}`, challenge.hint, false);
            } else if (definitions) {
                showModal(definitions.title.toUpperCase(), definitions.definition, false);
            } else {
                showModal("DATA INQUIRY", "Use the provided data (P, V, F, S) to solve the business math problem.", false);
            }
        }

        function performRestart() {
            currentScore = 0;
            currentRound = 0; // Reset to 0 (game not started)
            currentLevelIndex = 0; // Reset level
            document.getElementById('feedbackMessage').style.display = 'none';
            document.getElementById('submitButton').style.display = 'block';
            document.getElementById('nextButton').style.display = 'none';
                        
            // Initialize inputs to Level 1 data
            initializeInputs(); 
                         
            // Update local UI
            document.getElementById('scoreDisplay').textContent = `SCORE: 0 PTS (Lvl 1, Rnd 0/${totalGameRounds})`;

            // Push reset to Firebase (updateSoloState is called by nextRound)
            nextRound(); // Start Round 1
        }

        function restartGame(isInitialStart = false) {
            if (!isInitialStart) {
                showModal("CONFIRM REINITIALIZATION", `WARNING: Restarting will erase all current progress and score, resetting your challenge to Level 1, Round 1. Proceed?`, true, (confirmed) => {
                    if (confirmed) {
                        performRestart();
                    }
                });
            } else {
                // If this is the initial start, check if we need to resume
                if (currentRound > 0) {
                     showModal("DATA SYNCHRONIZED", `Welcome back, ${myPlayerName}! Resuming challenge from Level ${gameLevels[currentLevelIndex].level}, Round ${currentRound}/${totalGameRounds}.`, false, () => {
                        goToRound(currentRound); // Load the round we were on
                     });
                     return;
                }
                
                performRestart();
            }
        }

        function nextRound(doIncrement = true) {
            if (doIncrement) {
                currentRound++;
            }

            if (currentRound > totalGameRounds) {
                finishGame();
                return;
            }
                        
            const currentChallengeIndex = (currentRound - 1) % roundsPerLevel;

            // Check for level transition (e.g., transition from Round 8 to 9)
            if (currentRound > 1 && currentChallengeIndex === 0) {
                currentLevelIndex++;
                initializeInputs(); // Load new level data
                // Show a quick modal for level transition
                showModal(`ACCESS GRANTED`, `LEVEL ${gameLevels[currentLevelIndex].level} ACTIVATED: ${gameLevels[currentLevelIndex].title.toUpperCase()}`, false);
            }
            
            updateRoundUI();
        }

        function submitAnswer() {
            if (currentRound === 0) {
                 // Guard clause for the initial state before any round has started
                 showModal("SYSTEM ALERT", "Challenge not active. Press 'NEXT CHALLENGE' or 'REINITIALIZE SYSTEM' to begin.", false);
                 return;
            }

            const playerAnswer = parseFloat(document.getElementById('answerInput').value);
            // Index is (currentRound - 1) % roundsPerLevel because currentRound is 1-indexed
            const currentChallengeIndex = (currentRound - 1) % roundsPerLevel; 
            const challenge = challenges[currentChallengeIndex];

            if (isNaN(playerAnswer)) {
                showModal("INVALID INPUT", "Please enter a valid numerical response.", false);
                return;
            }

            // Get current inputs from the UI (which are updated by initializeInputs)
            const P = parseFloat(document.getElementById('sellingPrice').value);
            const V = parseFloat(document.getElementById('variableCost').value);
            const F = parseFloat(document.getElementById('fixedCosts').value);
            const S = parseFloat(document.getElementById('salesUnits').value);
                        
            const correctAnswer = parseFloat(challenge.calculate(P, V, F, S));
            const tolerance = 0.05; // Allow for slight rounding errors up to 5 cents/units

            const feedbackDiv = document.getElementById('feedbackMessage');
            feedbackDiv.style.display = 'block';

            if (Math.abs(playerAnswer - correctAnswer) <= tolerance) {
                const points = challenge.difficulty;
                currentScore += points;
                feedbackDiv.className = 'feedback-correct';
                feedbackDiv.textContent = `✅ SUCCESS! TARGET ACQUIRED. You earned ${points} points. Correct value: ${challenge.unit} ${correctAnswer}.`;
                                
                document.getElementById('submitButton').style.display = 'none';
                document.getElementById('nextButton').style.display = 'block';

            } else {
                const penalty = 10; // Simple fixed penalty
                currentScore = Math.max(0, currentScore - penalty);
                feedbackDiv.className = 'feedback-incorrect';
                feedbackDiv.textContent = `❌ FAILURE. INACCURATE DATA. Correct value: ${challenge.unit} ${correctAnswer}. Score penalty: ${penalty} points.`;

                document.getElementById('submitButton').style.display = 'none';
                document.getElementById('nextButton').style.display = 'block';
            }

            // Update local score display
            const currentLevel = gameLevels[currentLevelIndex].level;
            document.getElementById('scoreDisplay').textContent = `SCORE: ${currentScore} PTS (Lvl ${currentLevel}, Rnd ${currentRound}/${totalGameRounds})`;

            // Push the score update to Firebase regardless of correctness
            updateSoloState();
        }

        function finishGame() {
            const finalLevel = Math.floor((currentRound - 1) / roundsPerLevel) + 1;
            showModal("MISSION COMPLETE",
                      `MISSION ACCOMPLISHED, AGENT ${myPlayerName}!\n\nFinal Status: Level ${finalLevel}, Round ${currentRound}/${totalGameRounds}\nFinal Score: ${currentScore} points.`,
                      false,
                      () => performRestart() // Offer immediate restart without modal confirmation
            );
            // Hide all action buttons after finishing
            document.getElementById('submitButton').style.display = 'none';
            document.getElementById('nextButton').style.display = 'none';
            document.getElementById('answerInput').disabled = true;
        }

        // --- Window Load ---
        window.onload = initializeFirebase;
        window.startGame = startGame;
        window.nextRound = nextRound;
        window.submitAnswer = submitAnswer;
        window.restartGame = restartGame;
        window.finishGame = finishGame;
        window.showHelp = showHelp; // Expose help function
    </script>
</body>
</html>
